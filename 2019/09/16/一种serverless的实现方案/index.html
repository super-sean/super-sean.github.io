<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>一种serverless的实现方案 | Sean's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一种serverless的实现方案</h1><a id="logo" href="/.">Sean's Blog</a><p class="description">随性随心</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">一种serverless的实现方案</h1><div class="post-meta">Sep 16, 2019<span> | </span><span class="category"><a href="/categories/设计/">设计</a></span></div><div class="post-content"><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>自从上次参加qcon开发者大会，一直在思考serviceless的可执行方案，一路上也在公司推进中，虽然进度有点慢，没办法，业务太忙了。。。  </p>
<h3 id="架构总览"><a href="#架构总览" class="headerlink" title="架构总览"></a>架构总览</h3><img src="/2019/09/16/一种serverless的实现方案/vod_serviceless.png" title="架构">  
<h3 id="服务模块"><a href="#服务模块" class="headerlink" title="服务模块"></a>服务模块</h3><h4 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h4><p>需要实现配置化扩展及热更新接口服务，主要需要支持数据的curd场景。抽象的说其实只有2种场景，就是数据的查询和变更。    </p>
<p>抽象交互场景，制定一套接口使用规范  </p>
<h5 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h5><p>查询一般分明细查询和聚合查询，核心结构如下：</p>
<ul>
<li>字段列表<br>  支持别名，数据格式定义</li>
<li>请求参数列表（过滤）<br>  支持别名，请求参数类型（如日期、范围、字段值匹配等）</li>
<li>排序<br>  支持别名，排序类型（升序降序）</li>
<li>分页<br>  游标或者页码</li>
</ul>
<p>之前已经有 <a href="/2019/05/15/基于solr服务提供通用配置化接口服务/">基于solr服务提供通用配置化接口服务</a>  可以参考  </p>
<h5 id="变更"><a href="#变更" class="headerlink" title="变更"></a>变更</h5><p>变更一般有replace和del场景，del比较简单，只需要请求参数列表即可。replace的核心结构如下：</p>
<ul>
<li>变更数据<br>  以key value的形式传参，支持伪cas，传key的原值，如果不是原值放弃修改  </li>
<li>请求参数列表（过滤）<br>  支持别名，请求参数类型（如日期、范围、字段值匹配等）</li>
</ul>
<h5 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h5><p>需要针对使用方提供租赁服务，查询接口限流，变更接口安全参数派发及验证</p>
<h4 id="语法引擎"><a href="#语法引擎" class="headerlink" title="语法引擎"></a>语法引擎</h4><p>需要根据接口配置模板选择不同的数据源的语法进行转译，最基本的支持sql查询模板（<a href="/2018/10/07/JAVA动态编译-解析文本的简易方法/">JAVA动态编译/解析文本的一种简易方法</a>）,如果存储层有不支持sql的中间件或者引擎，就需要定向开发。参考<a href="/2018/11/23/datax源码解析及分布式实现思路/">datax的设计</a>，抽象组件,只针对reader和writer编程，以插件的形式加入项目对应的目录和修改对应的配置文件即可。  </p>
<h4 id="存储及查询引擎"><a href="#存储及查询引擎" class="headerlink" title="存储及查询引擎"></a>存储及查询引擎</h4><p>其实最简单在这一层添加个db，就已经能把一个简单的serviceless架构跑起来了</p>
<h5 id="apache-kudu-impala"><a href="#apache-kudu-impala" class="headerlink" title="apache kudu + impala"></a>apache kudu + impala</h5><p>考虑到高可用、高性能、扩展性和成本的问题，又要支持oltp和olap，选择普通db的话很快就会到整套服务各方面的天花板，参考<a href="http://www.clickhouse.com.cn/topic/5c453371389ad55f127768ea" target="_blank" rel="noopener">开源OLAP引擎测评报告</a>  </p>
<p>联表查询性能<br><img src="/2019/09/16/一种serverless的实现方案/multi_table_report.jpeg" title="多表"></p>
<p>单表查询性能<br><img src="/2019/09/16/一种serverless的实现方案/single_table_report.jpeg" title="单表"></p>
<p>综合对比<br><img src="/2019/09/16/一种serverless的实现方案/all_consider.jpeg" title="对比"></p>
<p>综合考虑下选择impala  </p>
<p>考虑kudu的原因，参考<a href="https://cloud.tencent.com/developer/news/391226" target="_blank" rel="noopener">有了HBase为什么还要Kudu</a>  </p>
<p>其实选型上也是考虑到大厂都有在使用，impala不用说了，很多公司都用到tx/ali/神策等，kudu像京东/小米都有在用。正准备在公司申请开发环境进行探研。</p>
<h5 id="搜索引擎"><a href="#搜索引擎" class="headerlink" title="搜索引擎"></a>搜索引擎</h5><p>搜索引擎在明细查询上有很优秀的支持，如es、solr</p>
<h5 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h5><p>业务很常用的，在数据存储上没太高要求的前提下的性能最优选择  </p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>以上模块的运作需要有一套元数据设计来支持，元数据主要包括几方面：</p>
<ul>
<li>应用信息</li>
<li>安全信息，比如盐信息</li>
<li>接口描述</li>
<li>针对sql及特定语法的接口配置信息，之前已经有 <a href="/2019/05/15/基于solr服务提供通用配置化接口服务/">基于solr服务提供通用配置化接口服务</a>  可以参考  </li>
<li>数据源信息</li>
<li>异常策略等</li>
</ul>
<h5 id="云函数"><a href="#云函数" class="headerlink" title="云函数"></a>云函数</h5><p>sql和代码加载（代码块及jar包上传）两种实现思路，sql是成本最低，但是也限制比较多，代码热加载会有一些性能和安全隐患问题，需要额外的成本去维护。</p>
<h4 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h4><p>使用了非普通db存储的方案，而且serviceless的目标并不是也不可能覆盖所有的场景，那就肯定存在需要进行数据同步的情况，数据同步行业内主要分批处理和流处理两种，当然直接服务对接也可以，不过不建议，因为会对接服务多了，会比较很难把控。  </p>
<h5 id="批处理"><a href="#批处理" class="headerlink" title="批处理"></a>批处理</h5><p>使用azkaban进行离线调度是现在很多公司会做的，我们公司的大数据部门也即将提供基于azkaban改造的调度系统，可直接对接使用  </p>
<h5 id="流数据"><a href="#流数据" class="headerlink" title="流数据"></a>流数据</h5><p>如果是面向业务的场景的，其实并没有像大数据场景那种实时更新模型推荐的需要，主要是想支持实时更新，使用kafka 和kafka streams 基本能满足(<a href="/2018/08/11/spring-cloud-stream-基于kafka的使用简析/">spring cloud stream 基于kafka的使用简析</a>)。还有其它工具，如kettle或者apache nifi，但是考虑到是面向研发特性不建议直接使用这种数据处理流工具。这里更想提的其实是管道处理和管理的能力搭建。  </p>
<p>数据的产生之后（source），会经过一到多层的中间处理（processor），最终将结果落地到某个地方（sink），基于这样的理念，可以很容易基于kafka抽象一套服务出来。但是缺少平台把控能力。  </p>
<p><a href="https://dataflow.spring.io/docs/concepts/architecture/" target="_blank" rel="noopener">spring cloud data flow</a> 就是管道管理平台，有很多现成的组件。SCDF (Spring Cloud Data Flow)的核心功能是ETL （Extract, Transform, Load ），Extract，Transform，Load 分别对应上图的Source，Processor 和Sink，这三个组件是Spring Boot 微服务，部署运行在SCDF之上的，三个微服务放在一起构成一个Stream（pipeline）用来实现数据处理，它们之间通过AMQP进行异步的消息传递。</p>
<p>架构简析<br><img src="/2019/09/16/一种serverless的实现方案/spring_cloud_data_flow.png" title="spring">  </p>
<p>SCDF 由下面的Spring Cloud家族成员组成<br><img src="/2019/09/16/一种serverless的实现方案/spring_cloud_data_flow_modules.png" title="spring">  </p>
<p>服务组件<br>  </p>
<p>流处理<br>  </p>
  
<p>批处理支持  </p>
  
<p>后台支持语言定义流程及拖拽操作<br><img src="/2019/09/16/一种serverless的实现方案/spring_cloud_data_flow_back.png" title="spring">  </p>
<p>但是实践下来发现两个问题，一个是不能有通用组件环节，它是以cicd流水线管理方式，每条流水线的应用都得重新部署,没有公共流水线的概念（有可能我使用姿势不对?）,另一个问题是如果使用SCDF，就得跟公司现有的使用框架及发布部署平台对接，需要进行改造，这其中的成本也不小。  </p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>基本上serviceless的一种实现思路及方案已经描述完了，这其中会有很多技术难点及问题，之后在推进过程中再一一细述。</p>
</div><div class="tags"><a href="/tags/架构/">架构</a><a href="/tags/serviceless/">serviceless</a></div><div class="post-nav"><a class="pre" href="/2019/10/20/商业化产品规划与服务架构思考/">商业化产品规划与服务架构思考</a><a class="next" href="/2019/07/14/Qcon广州站大会个人纪要/">Qcon广州站</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://super-sean.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计/">设计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/java基础/" style="font-size: 15px;">java基础</a> <a href="/tags/动态解析/" style="font-size: 15px;">动态解析</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/qcon/" style="font-size: 15px;">qcon</a> <a href="/tags/数据平台/" style="font-size: 15px;">数据平台</a> <a href="/tags/ETL/" style="font-size: 15px;">ETL</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/实时流/" style="font-size: 15px;">实时流</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/队列/" style="font-size: 15px;">队列</a> <a href="/tags/JAVA基础/" style="font-size: 15px;">JAVA基础</a> <a href="/tags/优化/" style="font-size: 15px;">优化</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/数据分析/" style="font-size: 15px;">数据分析</a> <a href="/tags/并发编程/" style="font-size: 15px;">并发编程</a> <a href="/tags/serviceless/" style="font-size: 15px;">serviceless</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/10/20/商业化产品规划与服务架构思考/">商业化产品规划与服务架构思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/16/一种serverless的实现方案/">一种serverless的实现方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/14/Qcon广州站大会个人纪要/">Qcon广州站</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/06/一次App首页代码优化纪要/">一次App首页代码优化纪要</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/19/GC问题解决的那些套路/">GC问题解决的那些套路</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/15/基于solr服务提供通用配置化接口服务/">基于solr服务提供通用配置化接口服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/04/long-gc案例分析/">long-gc案例分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/09/创业团队那些事/">创业团队那些事</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/datax源码解析及分布式实现思路/">datax源码解析及分布式实现思路</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/18/并发编程/">并发编程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Sean's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>