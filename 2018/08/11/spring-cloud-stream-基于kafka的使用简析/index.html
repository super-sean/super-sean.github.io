<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>spring cloud stream 基于kafka的使用简析 | Sean's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">spring cloud stream 基于kafka的使用简析</h1><a id="logo" href="/.">Sean's Blog</a><p class="description">随性随心</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">spring cloud stream 基于kafka的使用简析</h1><div class="post-meta">Aug 11, 2018<span> | </span><span class="category"><a href="/categories/大数据/">大数据</a></span></div><div class="post-content"><h4 id="流式数据"><a href="#流式数据" class="headerlink" title="流式数据"></a>流式数据</h4><p>故名思义，即数据像开了小河里的流水般不停流动，除非水源出现问题，否则没有结束时间。<br>流式数据在行业内已经有非常多针对不同应用量级的成熟方案，这里就不加以详述。本次主要介绍spring cloud stream 基于kafka对流式数据的基本应用。而使用spring cloud stream之前，可以先理解一下spring cloud对数据流程的几个概念，分别是source（生产数据者），processor(数据加工者), sink(最终结果处理者)。</p>
<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p><strong>项目基本框架</strong>:当然是基于maven构建的spring-boot最省心省力啦<br><strong>添加依赖</strong>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-cloud-stream-binder-kafka-streams&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-cloud-stream-binder-kafka&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 用于代码中的一些便捷注解 --&gt;</span><br><span class="line">      &lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;1.18.0&lt;/version&gt;</span><br><span class="line">	&lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>公共配置</strong>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">  	kafka:</span><br><span class="line">          streams:</span><br><span class="line">            binder:</span><br><span class="line">              brokers: localhost:9092</span><br><span class="line">              zk-nodes: localhost:2181 #2.0以上就不需要该配置</span><br><span class="line">              configuration:</span><br><span class="line">                default:</span><br><span class="line">                  key:</span><br><span class="line">                    serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                  value:</span><br><span class="line">                    serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                cache:</span><br><span class="line">                  max:</span><br><span class="line">                    bytes:</span><br><span class="line">                      buffering: 0 #所有线程可以用于缓存的最大字节数,达到多少数据量之后聚合一次流中的数据，设置为0则实时聚合</span><br><span class="line">                commit:</span><br><span class="line">                  interval:</span><br><span class="line">                    ms: 1000 #版本数据确认消费时间ack</span><br></pre></td></tr></table></figure></p>
<p>我们来模拟用户页面访问记录流</p>
<h4 id="声明binding相关信息"><a href="#声明binding相关信息" class="headerlink" title="声明binding相关信息"></a>声明binding相关信息</h4><p>添加接口AnalyticsBinding<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public interface AnalyticsBinding &#123;</span><br><span class="line">    String PAGE_VIEWS_OUT = &quot;pvout&quot;;</span><br><span class="line">    String PAGE_VIEWS_IN = &quot;pvin&quot;;</span><br><span class="line">    String PAGE_COUNT_MV = &quot;pcmv&quot;;</span><br><span class="line">    String PAGE_COUNT_OUT = &quot;pcout&quot;;</span><br><span class="line">    String PAGE_COUNT_IN = &quot;pcin&quot;;</span><br><span class="line"></span><br><span class="line">    @Input(PAGE_VIEWS_IN)</span><br><span class="line">    KStream&lt;String,PageViewEvent&gt; pageViewsIn();</span><br><span class="line"></span><br><span class="line">    @Output(PAGE_COUNT_OUT)</span><br><span class="line">    KStream&lt;String,Long&gt; pageCountOut();</span><br><span class="line"></span><br><span class="line">    @Input(PAGE_COUNT_IN)</span><br><span class="line">    KTable&lt;String,Long&gt; pageCountIn();</span><br><span class="line"></span><br><span class="line">    @Output(PAGE_VIEWS_OUT)</span><br><span class="line">    MessageChannel pageViewsOut();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h4><p>在application.yml中声明以下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">     stream:</span><br><span class="line">        bindings:</span><br><span class="line">          pvout:</span><br><span class="line">            destination: pvst</span><br><span class="line">            group: pvst</span><br><span class="line">            producer:</span><br><span class="line">              header-mode: raw</span><br><span class="line">          pvin:</span><br><span class="line">            destination: pvst</span><br><span class="line">            group: pvst</span><br><span class="line">            consumer:</span><br><span class="line">              header-mode: raw</span><br><span class="line">          pcout:</span><br><span class="line">            destination: pcst</span><br><span class="line">            group: pcst</span><br><span class="line">            producer:</span><br><span class="line">              use-native-encoding: true</span><br><span class="line">          pcin:</span><br><span class="line">            destination: pcst</span><br><span class="line">            group: pcst</span><br><span class="line">            content-type: application/json</span><br><span class="line">            consumer:</span><br><span class="line">              use-native-encoding: true</span><br><span class="line">              header-mode: raw</span><br><span class="line">        kafka:</span><br><span class="line">          streams:</span><br><span class="line">            bindings:</span><br><span class="line">              pcout:</span><br><span class="line">                producer:</span><br><span class="line">                  key-serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                  value-serde: org.apache.kafka.common.serialization.Serdes$LongSerde</span><br><span class="line">              pcin:</span><br><span class="line">                consumer:</span><br><span class="line">                  key-serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                  value-serde: org.apache.kafka.common.serialization.Serdes$LongSerde</span><br></pre></td></tr></table></figure></p>
<p>destination对应kafka中的主题。<br>serde就是serialization和deserialization，针对流中的key和value都需要指定，默认使用default中配置的内容，也可以针对主题单独设置。  </p>
<h4 id="source"><a href="#source" class="headerlink" title="source"></a>source</h4><p>创建每秒随机产生用户访问页面及停留时间的数据  </p>
<p>先创建事件类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">public class PageViewEvent &#123;</span><br><span class="line">    private String userId,page;</span><br><span class="line">    private long duration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>生成数据的实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@EnableBinding(AnalyticsBinding.class)</span><br><span class="line">public class PageViewEventSource implements ApplicationRunner &#123;</span><br><span class="line"></span><br><span class="line">    private  final MessageChannel pageViewsOut;</span><br><span class="line"></span><br><span class="line">    public PageViewEventSource(AnalyticsBinding binding) &#123;</span><br><span class="line">        this.pageViewsOut = binding.pageViewsOut();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(ApplicationArguments applicationArguments) throws Exception &#123;</span><br><span class="line">        List&lt;String&gt; names = Arrays.asList(&quot;jlong&quot;,&quot;dyser&quot;,&quot;shacko&quot;,&quot;abilan&quot;,&quot;ooasdf&quot;,&quot;grussell&quot;);</span><br><span class="line">        List&lt;String&gt; pages = Arrays.asList(&quot;blog&quot;,&quot;sitemap&quot;,&quot;initializr&quot;,&quot;news&quot;,&quot;colophon&quot;,&quot;about&quot;);</span><br><span class="line"></span><br><span class="line">        Runnable runnable = () -&gt; &#123;</span><br><span class="line">            String rPage = pages.get(new Random().nextInt(pages.size()));</span><br><span class="line">            String rName = names.get(new Random().nextInt(names.size()));</span><br><span class="line">            PageViewEvent pageViewEvent = new PageViewEvent(rName,rPage,Math.random() &gt; .5?10:1000);</span><br><span class="line">            Message&lt;PageViewEvent&gt; message = MessageBuilder.withPayload(pageViewEvent)</span><br><span class="line">                .setHeader(KafkaHeaders.MESSAGE_KEY,pageViewEvent.getUserId().getBytes())</span><br><span class="line">                .build();</span><br><span class="line">            try &#123;</span><br><span class="line">                this.pageViewsOut.send(message);</span><br><span class="line">                log.info(&quot;sent&quot; + message.toString());</span><br><span class="line">            &#125; catch (Exception e)&#123;</span><br><span class="line">                log.error(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Executors.newScheduledThreadPool(1).scheduleAtFixedRate(runnable,1,1, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="processor"><a href="#processor" class="headerlink" title="processor"></a>processor</h4><p>获取到事件数据之后基于聚合处理，创建新的数据流<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class PageViewEventProcessor &#123;</span><br><span class="line">    @StreamListener</span><br><span class="line">    @SendTo(AnalyticsBinding.PAGE_COUNT_OUT)</span><br><span class="line">    public  KStream&lt;String,Long&gt; process(</span><br><span class="line">            @Input(AnalyticsBinding.PAGE_VIEWS_IN) KStream&lt;String,PageViewEvent&gt; events)&#123;</span><br><span class="line">        return events</span><br><span class="line">                .map((key,value) -&gt; new KeyValue&lt;&gt;(value.getUserId() + &quot;-&quot; + value.getPage(),&quot;0&quot;))</span><br><span class="line">                .groupByKey()</span><br><span class="line">                //.windowedBy(TimeWindows.of(1000*60)) </span><br><span class="line">                .count(Materialized.as(AnalyticsBinding.PAGE_COUNT_MV))</span><br><span class="line">                .toStream();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>windowedBy可以根据时间窗口进行聚合，用法请详见文档。  </p>
<h4 id="sink"><a href="#sink" class="headerlink" title="sink"></a>sink</h4><p>获取聚合后的结果进行处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class PageCountSink &#123;</span><br><span class="line"></span><br><span class="line">    @StreamListener</span><br><span class="line">    public void process(@Input(AnalyticsBinding.PAGE_COUNT_IN)KTable&lt;String,Long&gt; counts)&#123;</span><br><span class="line">        counts.toStream().foreach((key,value) -&gt; log.info(&quot;PCIN -----:&quot; + key + &quot;=&quot; + value));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至此一个从数据生产到结果消费的简单数据流处理就完成了</p>
<h4 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h4><p>这个例子是基于spring cloud 完整的流数据处理，有source,processor,sink的概念是spring cloud data flow的设计理念，这里不展开阐述。<br>processor环节非必需的，可以只有source和sink的实现。<br>假如不需要进行流的处理，只需要消息内容，可以在@StreamListener的方法声明中不使用@Input声明，而是直接通过@StreamListener(主题名称)来进行监听，<br>方法接收消息参数使用Message<t> msg，如下:</t></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@StreamListener(Processor.INPUT)</span><br><span class="line">	public void receive1(Message&lt;String&gt; msg)&#123;</span><br><span class="line">		System.out.println(msg.getPayload()); //消息体</span><br><span class="line">		Acknowledgment acknowledgment = msg.getHeaders().get(KafkaHeaders.ACKNOWLEDGMENT, Acknowledgment.class);</span><br><span class="line">		if (acknowledgment != null) &#123;</span><br><span class="line">			System.out.println(&quot;Acknowledgment provided&quot;);</span><br><span class="line">			acknowledgment.acknowledge();//手动ack</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h4 id="多流聚合"><a href="#多流聚合" class="headerlink" title="多流聚合"></a>多流聚合</h4><p>在实际应用中不只存在单流数据的处理，也经常会遇到多流聚合处理。<br>我们来添加多一种事件的实现，这里模拟销售数据。相关的实现如下  </p>
<p>SalesEvent<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">public class SalesEvent &#123;</span><br><span class="line">    private String userId,goods;</span><br><span class="line">    private int amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SalesEventSource<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@EnableBinding(AnalyticsBinding.class)</span><br><span class="line">public class SalesEventSource implements ApplicationRunner &#123;</span><br><span class="line">    private  final MessageChannel salesOut;</span><br><span class="line"></span><br><span class="line">    public SalesEventSource(AnalyticsBinding binding) &#123;</span><br><span class="line">        this.salesOut = binding.salesOut();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(ApplicationArguments applicationArguments) throws Exception &#123;</span><br><span class="line">        List&lt;String&gt; names = Arrays.asList(&quot;jlong&quot;,&quot;dyser&quot;,&quot;shacko&quot;,&quot;abilan&quot;,&quot;ooasdf&quot;,&quot;grussell&quot;);</span><br><span class="line">        List&lt;String&gt; goods = Arrays.asList(&quot;apple&quot;,&quot;oringe&quot;,&quot;banana&quot;,&quot;lemon&quot;,&quot;shit&quot;,&quot;book&quot;);</span><br><span class="line">        Runnable runnable = () -&gt; &#123;</span><br><span class="line">            String rGoods = goods.get(new Random().nextInt(goods.size()));</span><br><span class="line">            String rName = names.get(new Random().nextInt(names.size()));</span><br><span class="line">            SalesEvent salesEvent = new SalesEvent(rName,rGoods,Math.random() &gt; .5?5:10);</span><br><span class="line">            Message&lt;SalesEvent&gt; message = MessageBuilder.withPayload(salesEvent)</span><br><span class="line">                    .setHeader(KafkaHeaders.MESSAGE_KEY,salesEvent.getUserId().getBytes())</span><br><span class="line">                    .build();</span><br><span class="line">            try &#123;</span><br><span class="line">                this.salesOut.send(message);</span><br><span class="line">                log.info(&quot;sent&quot; + message.toString());</span><br><span class="line">            &#125; catch (Exception e)&#123;</span><br><span class="line">                log.error(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Executors.newScheduledThreadPool(1).scheduleAtFixedRate(runnable,1,1, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SalesEventProcessor<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@EnableBinding(AnalyticsBinding.class)</span><br><span class="line">public class SalesEventProcessor &#123;</span><br><span class="line">    @StreamListener</span><br><span class="line">    @SendTo(AnalyticsBinding.SALES_COUNT_OUT)</span><br><span class="line">    public KStream&lt;String,Long&gt; process(@Input(AnalyticsBinding.SALES_IN)KStream&lt;String,SalesEvent&gt; events)&#123;</span><br><span class="line">        return events</span><br><span class="line">                .map((key,value) -&gt; new KeyValue&lt;&gt;(value.getUserId() + &quot;-&quot; + value.getGoods(),&quot;0&quot;))</span><br><span class="line">                .groupByKey()</span><br><span class="line">                //.windowedBy(TimeWindows.of(1000*60))</span><br><span class="line">                .count(Materialized.as(AnalyticsBinding.SALES_COUNT_MV))</span><br><span class="line">                .toStream();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SaleCountSink<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">@EnableBinding(AnalyticsBinding.class)</span><br><span class="line">public class SaleCountSink &#123;</span><br><span class="line"></span><br><span class="line">    @StreamListener</span><br><span class="line">    public void process(@Input(AnalyticsBinding.SALES_COUNT_IN)KTable&lt;String,Long&gt; salesCounts,</span><br><span class="line">                        @Input(AnalyticsBinding.PAGE_COUNT_IN)KTable&lt;String,Long&gt; pageCounts)&#123;</span><br><span class="line">        salesCounts.toStream().map((k,v) -&gt; new KeyValue&lt;&gt;(k.split(&quot;-&quot;)[0],k.split(&quot;-&quot;)[1] + &quot;-&quot; + v))</span><br><span class="line">                .join(pageCounts.toStream().map((k,v) -&gt; &#123;</span><br><span class="line">                            System.out.println(&quot;-------&quot; + k +&quot; : &quot; + v );</span><br><span class="line">                            return new KeyValue&lt;&gt;(k.split(&quot;-&quot;)[0],k.split(&quot;-&quot;)[1] + &quot;-&quot; + v);&#125;),</span><br><span class="line">                        (v1, v2) -&gt; v1 + &quot;:&quot; + v2,</span><br><span class="line">                        JoinWindows.of(10000)</span><br><span class="line">                        )</span><br><span class="line">                .foreach((k,v) -&gt; System.out.println(k+ &quot;---&quot; + v));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：同个应用中对同个流的监听实例只能有一个，SaleCountSink使用了@Input(AnalyticsBinding.PAGE_COUNT_IN)KTable&lt;String,Long&gt;<br>与PageCountSink有冲突，要嘛把PageCountSink中的监听去掉，要嘛重命名其中一个相关的监听配置</p>
<p>AnalyticsBinding 完整代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public interface AnalyticsBinding &#123;</span><br><span class="line">    String PAGE_VIEWS_OUT = &quot;pvout&quot;;</span><br><span class="line">    String PAGE_VIEWS_IN = &quot;pvin&quot;;</span><br><span class="line">    String PAGE_COUNT_MV = &quot;pcmv&quot;;</span><br><span class="line">    String PAGE_COUNT_OUT = &quot;pcout&quot;;</span><br><span class="line">    String PAGE_COUNT_IN = &quot;pcin&quot;;</span><br><span class="line">    String SALES_OUT = &quot;salesout&quot;;</span><br><span class="line">    String SALES_IN = &quot;salesin&quot;;</span><br><span class="line">    String SALES_COUNT_MV = &quot;scmv&quot;;</span><br><span class="line">    String SALES_COUNT_OUT = &quot;scout&quot;;</span><br><span class="line">    String SALES_COUNT_IN = &quot;scin&quot;;</span><br><span class="line"></span><br><span class="line">    @Input(PAGE_VIEWS_IN)</span><br><span class="line">    KStream&lt;String,PageViewEvent&gt; pageViewsIn();</span><br><span class="line"></span><br><span class="line">    @Output(PAGE_COUNT_OUT)</span><br><span class="line">    KStream&lt;String,Long&gt; pageCountOut();</span><br><span class="line"></span><br><span class="line">    @Input(PAGE_COUNT_IN)</span><br><span class="line">    KTable&lt;String,Long&gt; pageCountIn();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Output(PAGE_VIEWS_OUT)</span><br><span class="line">    MessageChannel pageViewsOut();</span><br><span class="line"></span><br><span class="line">    @Output(SALES_OUT)</span><br><span class="line">    MessageChannel salesOut();</span><br><span class="line"></span><br><span class="line">    @Input(SALES_IN)</span><br><span class="line">    KStream&lt;String,SalesEvent&gt; salesIn();</span><br><span class="line"></span><br><span class="line">    @Output(SALES_COUNT_OUT)</span><br><span class="line">    KStream&lt;String,Long&gt; salesCountOut();</span><br><span class="line"></span><br><span class="line">    @Input(SALES_COUNT_IN)</span><br><span class="line">    KTable&lt;String,Long&gt; salesCountIn();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>application.yml完整配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8388</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: input-demo</span><br><span class="line">  cloud:</span><br><span class="line">     instance-count: 1</span><br><span class="line">     instance-index: 0</span><br><span class="line">     stream:</span><br><span class="line">        bindings:</span><br><span class="line">          pvout:</span><br><span class="line">            destination: pvst</span><br><span class="line">            group: pvst</span><br><span class="line">            producer:</span><br><span class="line">              header-mode: raw</span><br><span class="line">          pvin:</span><br><span class="line">            destination: pvst</span><br><span class="line">            group: pvst</span><br><span class="line">            consumer:</span><br><span class="line">              header-mode: raw</span><br><span class="line">          pcout:</span><br><span class="line">            destination: pcst</span><br><span class="line">            group: pcst</span><br><span class="line">            producer:</span><br><span class="line">              use-native-encoding: true</span><br><span class="line">          pcin:</span><br><span class="line">            destination: pcst</span><br><span class="line">            group: pcst</span><br><span class="line">            content-type: application/json</span><br><span class="line">            consumer:</span><br><span class="line">              use-native-encoding: true</span><br><span class="line">              header-mode: raw</span><br><span class="line">          salesout:</span><br><span class="line">            destination: sost</span><br><span class="line">            group: sost</span><br><span class="line">            producer:</span><br><span class="line">              header-mode: raw</span><br><span class="line">          salesin:</span><br><span class="line">            destination: sost</span><br><span class="line">            group: sost</span><br><span class="line">            consumer:</span><br><span class="line">              header-mode: raw</span><br><span class="line">          scout:</span><br><span class="line">            destination: scst</span><br><span class="line">            group: scst</span><br><span class="line">            producer:</span><br><span class="line">              use-native-encoding: true</span><br><span class="line">          scin:</span><br><span class="line">            destination: scst</span><br><span class="line">            group: scst</span><br><span class="line">            content-type: application/json</span><br><span class="line">            consumer:</span><br><span class="line">              use-native-encoding: true</span><br><span class="line">              header-mode: raw</span><br><span class="line">        kafka:</span><br><span class="line">          streams:</span><br><span class="line">            binder:</span><br><span class="line">              configuration:</span><br><span class="line">                default:</span><br><span class="line">                  key:</span><br><span class="line">                    serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                  value:</span><br><span class="line">                    serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                cache:</span><br><span class="line">                  max:</span><br><span class="line">                    bytes:</span><br><span class="line">                      buffering: 0</span><br><span class="line">                commit:</span><br><span class="line">                  interval:</span><br><span class="line">                    ms: 1000 </span><br><span class="line">              brokers: localhost:9092</span><br><span class="line">              zk-nodes: localhost:2181</span><br><span class="line">            bindings:</span><br><span class="line">              pcout:</span><br><span class="line">                producer:</span><br><span class="line">                  key-serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                  value-serde: org.apache.kafka.common.serialization.Serdes$LongSerde</span><br><span class="line">              pcin:</span><br><span class="line">                consumer:</span><br><span class="line">                  key-serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                  value-serde: org.apache.kafka.common.serialization.Serdes$LongSerde         </span><br><span class="line">              scout:</span><br><span class="line">                producer:</span><br><span class="line">                  key-serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                  value-serde: org.apache.kafka.common.serialization.Serdes$LongSerde</span><br><span class="line">              scin:</span><br><span class="line">                consumer:</span><br><span class="line">                  key-serde: org.apache.kafka.common.serialization.Serdes$StringSerde</span><br><span class="line">                  value-serde: org.apache.kafka.common.serialization.Serdes$LongSerde</span><br></pre></td></tr></table></figure></p>
<p>多流合并的理念是把流两两之间的key处理成一样进行join处理，join的实现方法大家可以自行阅读文档。如果是三个流以上，需要先将两个流合并之后生成一个流再与第三流合并处理。</p>
<h4 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h4><ul>
<li><a href="https://docs.spring.io/spring-cloud-dataflow/docs/1.6.0.RELEASE/reference/htmlsingle/" target="_blank" rel="noopener">spring cloud data flow</a></li>
<li><a href="https://docs.spring.io/spring-cloud-stream/docs/Brooklyn.RELEASE/reference/html/index.html" target="_blank" rel="noopener">spring cloud stream</a></li>
<li><a href="https://spring.io/blog/2018/04/04/spring-tips-spring-cloud-stream-kafka-streams" target="_blank" rel="noopener">spring cloud stream kafka streams应用官方视频讲解</a></li>
<li><a href="https://www.jianshu.com/p/45ba430e59f6" target="_blank" rel="noopener">KTable与KStream的关系</a></li>
<li><a href="http://kafka.apache.org/documentation/" target="_blank" rel="noopener">kafka官方文档</a></li>
<li><a href="https://www.cnblogs.com/devos/p/5616086.html" target="_blank" rel="noopener">kafka streams window的概念翻译版</a></li>
<li>kafka权威指南</li>
</ul>
</div><div class="tags"><a href="/tags/实时流/">实时流</a><a href="/tags/spring/">spring</a><a href="/tags/kafka/">kafka</a></div><div class="post-nav"><a class="pre" href="/2018/08/14/天然苏打水市场的了解与思考/">天然苏打水市场的了解与分析</a><a class="next" href="/2018/07/23/内存与JVM/">内存与JVM</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://super-sean.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计/">设计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/数据平台/" style="font-size: 15px;">数据平台</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/java基础/" style="font-size: 15px;">java基础</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/动态解析/" style="font-size: 15px;">动态解析</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/实时流/" style="font-size: 15px;">实时流</a> <a href="/tags/ETL/" style="font-size: 15px;">ETL</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/队列/" style="font-size: 15px;">队列</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/JAVA基础/" style="font-size: 15px;">JAVA基础</a> <a href="/tags/并发编程/" style="font-size: 15px;">并发编程</a> <a href="/tags/数据分析/" style="font-size: 15px;">数据分析</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/19/GC问题解决的那些套路/">GC问题解决的那些套路</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/15/基于solr服务提供通用配置化接口服务/">基于solr服务提供通用配置化接口服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/04/long-gc案例分析/">long-gc案例分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/09/创业团队那些事/">创业团队那些事</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/datax源码解析及分布式实现思路/">datax源码解析及分布式实现思路</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/18/并发编程/">并发编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/07/JAVA动态编译-解析文本的简易方法/">JAVA动态编译/解析文本的一种简易方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/19/个人基于大数据平台的设计与思考/">个人基于大数据平台的设计与思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/14/天然苏打水市场的了解与思考/">天然苏打水市场的了解与分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/11/spring-cloud-stream-基于kafka的使用简析/">spring cloud stream 基于kafka的使用简析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Sean's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>